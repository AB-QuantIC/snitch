# Copyright 2020 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

name: lint
on: [push]

jobs:
    # Run all lint checks
    lint-verilog:
        name: Lint Verilog
        # This job runs on Linux (fixed ubuntu version)
        runs-on: ubuntu-18.04
        env:
            VERIBLE_VERSION: v0.0-557-g287da29
        steps:
            - uses: actions/checkout@v2
            - name: Install Verible
              run: |
                set -e
                mkdir -p build/verible
                cd build/verible
                curl -Ls -o verible.tar.gz https://github.com/google/verible/releases/download/$VERIBLE_VERSION/verible-$VERIBLE_VERSION-Ubuntu-18.04-bionic-x86_64.tar.gz
                sudo mkdir -p /tools/verible && sudo chmod 777 /tools/verible
                tar -C /tools/verible -xf verible.tar.gz --strip-components=1
                echo "::add-path::/tools/verible/bin"
            # Run linter in hw/ip subdir
            - name: Run Lint
              run: |
                echo "::add-matcher::.github/verible-lint-matcher.json"
                util/verible-lint.sh
                echo "::remove-matcher owner=verible-lint-matcher::"
    # Check that all vendored sources are up-to-date.
    vendor-licence:
        name: Check vendored source up-to-date and licence.
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-python@v2
              with:
                python-version: 3.x
            - name: Install requirements
              run: pip install -r python-requirements.txt
            - name: Re-vendor and diff
              run: |
                find . \
                    -name '*.vendor.hjson' \
                    | xargs -n1 util/vendor.py --verbose \
                    && git diff --exit-code
            - name: Check license
              run: |
                ./util/lowrisc_misc-linters/licence-checker/licence-checker.py --config util/licence-checker.hjson
